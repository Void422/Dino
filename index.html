<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dino Customizer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--line:#e6e6e6}
    *{box-sizing:border-box}
    body{font-family:system-ui,Arial;margin:18px;color:#111}
    h2{margin:0 0 14px}
    .box{display:grid;place-items:center;background:#fafafa;border:1px solid var(--line);border-radius:14px;padding:16px;max-width:680px}
    canvas{width:min(520px,92vw);height:auto;image-rendering:crisp-edges}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:14px 0}
    .card{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-top:10px}
    .sw{display:flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:10px;padding:8px;cursor:pointer;background:#fff}
    .chip{width:28px;height:28px;border-radius:8px;border:1px solid #ddd;flex:0 0 28px}
    .meta{font-size:12px;line-height:1.2}
    .id{font-weight:600}
    .miss{opacity:.45;cursor:not-allowed;background:#f4f4f4}
    .head{display:flex;justify-content:space-between;align-items:center}
    select,button{padding:7px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
    button:hover, .sw:hover{border-color:#bdbdbd}
    .cnt{font-size:12px;color:#666}
  </style>
</head>
<body>
  <h2>Dino Customizer</h2>

  <div class="box"><canvas id="c"></canvas></div>

  <div class="row card head" style="max-width:680px">
    <div>
      <strong>Body set:</strong>
      <select id="grp">
        <option>N</option><option>R</option><option>E</option><option>U</option><option>L</option>
      </select>
    </div>
    <div class="cnt" id="count"></div>
  </div>

  <div class="card" style="max-width:680px">
    <div id="bodyGrid" class="grid"></div>
  </div>

  <div class="row card" style="max-width:680px">
    <strong>Belly:</strong>
    <button data-e="#FFFFFF">N-0 • White</button>
    <button data-e="#BEBEBE">N-1 • #BEBEBE</button>
    <button data-e="#911B11">N-2 • #911B11</button>
  </div>

  <script>
  const BASE="N0_body.png"
  const MBODY="Mask_body.png"
  const MBELLY="Mask_belly.png"

  const bodyC={n0:"#E6E6E6",n1:"#ABABAB",n2:"#82180A"}
  const bellyC={n0:"#FFFFFF",n1:"#BEBEBE",n2:"#911B11"}
  let pickB="n0", pickE="n0"

  const c=document.getElementById("c"), x=c.getContext("2d")
  const cb=document.createElement("canvas"), xb=cb.getContext("2d")
  const cm1=document.createElement("canvas"), xm1=cm1.getContext("2d")
  const cm2=document.createElement("canvas"), xm2=cm2.getContext("2d")

  const img=new Image(), m1=new Image(), m2=new Image()
  img.crossOrigin=m1.crossOrigin=m2.crossOrigin="anonymous"
  img.src=BASE; m1.src=MBODY; m2.src=MBELLY

  let ok=0, bbBase, bbBody, bbBelly
  const done=()=>{ if(++ok<3)return
    const w=img.naturalWidth, h=img.naturalHeight
    c.width=w; c.height=h; cb.width=w; cb.height=h; cm1.width=w; cm1.height=h; cm2.width=w; cm2.height=h
    bbBase=bbox(img); bbBody=bbox(m1); bbBelly=bbox(m2)
    draw()
  }
  img.onload=done; m1.onload=done; m2.onload=done

  function bbox(im){
    const oc=document.createElement("canvas"), ox=oc.getContext("2d")
    oc.width=im.naturalWidth; oc.height=im.naturalHeight
    ox.drawImage(im,0,0)
    const d=ox.getImageData(0,0,oc.width,oc.height).data
    let minX=oc.width, minY=oc.height, maxX=-1, maxY=-1
    for(let y=0;y<oc.height;y++){
      for(let x=0;x<oc.width;x++){
        const i=(y*oc.width+x)*4+3
        if(d[i]>10){ if(x<minX)minX=x; if(y<minY)minY=y; if(x>maxX)maxX=x; if(y>maxY)maxY=y }
      }
    }
    if(maxX<0) return {x:0,y:0,w:oc.width,h:oc.height}
    return {x:minX,y:minY,w:maxX-minX+1,h:maxY-minY+1}
  }

  function hex2rgb(h){h=h.replace("#","");const n=parseInt(h,16);return{r:(n>>16)&255,g:(n>>8)&255,b:n&255}}
  function L(r,g,b){const mx=Math.max(r,g,b),mn=Math.min(r,g,b);return(mx+mn)/510}

  function paint(base,mask,col,orig){
    const bd=base.data, md=mask.data, od=orig.data, t=0.40, rgb=hex2rgb(col)
    for(let i=0;i<bd.length;i+=4){
      if(md[i+3]<=10)continue
      if(bd[i+3]<=10)continue
      if(L(od[i],od[i+1],od[i+2])<=t)continue
      bd[i]=rgb.r; bd[i+1]=rgb.g; bd[i+2]=rgb.b
    }
  }

  function draw(){
    xb.clearRect(0,0,cb.width,cb.height)
    xm1.clearRect(0,0,cm1.width,cm1.height)
    xm2.clearRect(0,0,cm2.width,cm2.height)

    xb.drawImage(img,0,0,cb.width,cb.height)

    xm1.drawImage(m1, bbBody.x, bbBody.y, bbBody.w, bbBody.h, bbBase.x, bbBase.y, bbBase.w, bbBase.h)
    xm2.drawImage(m2, bbBelly.x, bbBelly.y, bbBelly.w, bbBelly.h, bbBase.x, bbBase.y, bbBase.w, bbBase.h)

    const base=xb.getImageData(0,0,cb.width,cb.height)
    const orig=xb.getImageData(0,0,cb.width,cb.height)
    const maskE=xm2.getImageData(0,0,cm2.width,cm2.height)
    const maskB=xm1.getImageData(0,0,cm1.width,cm1.height)

    paint(base,maskE,bellyC[pickE],orig)
    paint(base,maskB,bodyC[pickB],orig)

    xb.putImageData(base,0,0)
    x.clearRect(0,0,c.width,c.height)
    x.drawImage(cb,0,0)
  }

  document.querySelectorAll("button[data-b]").forEach(b=>{
    b.onclick=()=>{pickB=b.getAttribute("data-b"); draw()}
  })
  document.querySelectorAll("button[data-e]").forEach(b=>{
    b.onclick=()=>{pickE=b.getAttribute("data-e"); draw()}
  })
</script>

</body>
</html>

